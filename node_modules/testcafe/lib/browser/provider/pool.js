"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const built_in_1 = __importDefault(require("./built-in"));
const plugin_host_1 = __importDefault(require("./plugin-host"));
const parse_provider_name_1 = __importDefault(require("./parse-provider-name"));
const _1 = __importDefault(require("./"));
const connection_1 = __importDefault(require("../connection"));
const runtime_1 = require("../../errors/runtime");
const types_1 = require("../../errors/types");
const BROWSER_PROVIDER_RE = /^([^:\s]+):?(.*)?$/;
const BROWSER_INFO_PROPERTIES = ['browserName', 'browserOption', 'providerName', 'provider'];
exports.default = {
    providersCache: {},
    async _handlePathAndCmd(alias) {
        const browserName = JSON.stringify(alias);
        const providerName = 'path';
        const provider = await this.getProvider(providerName);
        const browserOption = provider.plugin.getConfig(browserName);
        return { provider, providerName, browserName, browserOption };
    },
    async _parseAliasString(alias) {
        const providerRegExpMatch = BROWSER_PROVIDER_RE.exec(alias);
        if (!providerRegExpMatch)
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotFindBrowser, alias);
        let providerName = providerRegExpMatch[1];
        let browserName = providerRegExpMatch[2] || '';
        let browserOption = {};
        let provider = await this.getProvider(providerName);
        if (!provider && providerRegExpMatch[2])
            provider = await this.getProvider(providerName + ':');
        if (!provider) {
            providerName = 'locally-installed';
            provider = await this.getProvider(providerName);
            browserName = providerRegExpMatch[1] || '';
        }
        browserOption = provider.plugin.getConfig(browserName);
        return { provider, providerName, browserName, browserOption };
    },
    async _parseAlias(alias) {
        if (typeof alias === 'object') {
            if (BROWSER_INFO_PROPERTIES.every(property => property in alias))
                return alias;
            if (alias.path)
                return this._handlePathAndCmd(alias);
        }
        if (typeof alias === 'string')
            return this._parseAliasString(alias);
        throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotFindBrowser, alias);
    },
    async _getInfoForAllBrowserNames(provider, providerName) {
        const allBrowserNames = provider.isMultiBrowser ?
            await provider.getBrowserList() :
            [];
        if (!allBrowserNames.length)
            return { provider, providerName, browserName: '' };
        return allBrowserNames
            .map(browserName => ({ provider, providerName, browserName }));
    },
    _getProviderModule(providerName, moduleName) {
        try {
            // First, just check if the module exists
            require.resolve(moduleName);
        }
        catch (e) {
            // Module does not exist. Return null, and let the caller handle
            return null;
        }
        // Load the module
        const providerObject = require(moduleName);
        this.addProvider(providerName, providerObject);
        return this._getProviderFromCache(providerName);
    },
    _getProviderFromCache(providerName) {
        return this.providersCache[providerName] || null;
    },
    _getBuiltinProvider(providerName) {
        const providerObject = built_in_1.default[providerName];
        if (!providerObject)
            return null;
        this.addProvider(providerName, providerObject);
        return this._getProviderFromCache(providerName);
    },
    async getBrowserInfo(alias) {
        if (alias instanceof connection_1.default)
            return alias;
        const browserInfo = await this._parseAlias(alias);
        const { provider, providerName, browserName } = browserInfo;
        if (browserName === 'all')
            return await this._getInfoForAllBrowserNames(provider, providerName);
        if (!await provider.isValidBrowserName(browserName))
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotFindBrowser, alias);
        if (typeof alias !== 'string')
            alias = JSON.stringify(alias);
        return Object.assign({ alias }, browserInfo);
    },
    addProvider(providerName, providerObject) {
        providerName = parse_provider_name_1.default(providerName).providerName;
        this.providersCache[providerName] = new _1.default(new plugin_host_1.default(providerObject, providerName));
    },
    removeProvider(providerName) {
        providerName = parse_provider_name_1.default(providerName).providerName;
        delete this.providersCache[providerName];
    },
    async getProvider(providerName) {
        const parsedProviderName = parse_provider_name_1.default(providerName);
        const moduleName = parsedProviderName.moduleName;
        providerName = parsedProviderName.providerName;
        const provider = this._getProviderFromCache(providerName) ||
            this._getProviderModule(providerName, moduleName) ||
            this._getBuiltinProvider(providerName);
        if (provider)
            await this.providersCache[providerName].init();
        return provider;
    },
    dispose() {
        return Promise.all(Object.values(this.providersCache).map(item => item.dispose()));
    }
};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL3Bvb2wuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBNEM7QUFDNUMsZ0VBQXNEO0FBQ3RELGdGQUFzRDtBQUN0RCwwQ0FBaUM7QUFDakMsK0RBQThDO0FBQzlDLGtEQUFvRDtBQUNwRCw4Q0FBb0Q7QUFFcEQsTUFBTSxtQkFBbUIsR0FBTyxvQkFBb0IsQ0FBQztBQUNyRCxNQUFNLHVCQUF1QixHQUFHLENBQUMsYUFBYSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFN0Ysa0JBQWU7SUFDWCxjQUFjLEVBQUUsRUFBRTtJQUVsQixLQUFLLENBQUMsaUJBQWlCLENBQUUsS0FBSztRQUMxQixNQUFNLFdBQVcsR0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVDLE1BQU0sWUFBWSxHQUFJLE1BQU0sQ0FBQztRQUM3QixNQUFNLFFBQVEsR0FBUSxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDM0QsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFN0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFRCxLQUFLLENBQUMsaUJBQWlCLENBQUUsS0FBSztRQUMxQixNQUFNLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsbUJBQW1CO1lBQ3BCLE1BQU0sSUFBSSxzQkFBWSxDQUFDLHNCQUFjLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFcEUsSUFBSSxZQUFZLEdBQUksbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsSUFBSSxXQUFXLEdBQUssbUJBQW1CLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pELElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFcEQsSUFBSSxDQUFDLFFBQVEsSUFBSSxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7WUFDbkMsUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFFMUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLFlBQVksR0FBRyxtQkFBbUIsQ0FBQztZQUNuQyxRQUFRLEdBQU8sTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3BELFdBQVcsR0FBSSxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDL0M7UUFFRCxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFFLEtBQUs7UUFDcEIsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDO2dCQUM1RCxPQUFPLEtBQUssQ0FBQztZQUVqQixJQUFJLEtBQUssQ0FBQyxJQUFJO2dCQUNWLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzVDO1FBRUQsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRO1lBQ3pCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXpDLE1BQU0sSUFBSSxzQkFBWSxDQUFDLHNCQUFjLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUVELEtBQUssQ0FBQywwQkFBMEIsQ0FBRSxRQUFRLEVBQUUsWUFBWTtRQUNwRCxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDN0MsTUFBTSxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztZQUNqQyxFQUFFLENBQUM7UUFFUCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU07WUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBRXZELE9BQU8sZUFBZTthQUNqQixHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVELGtCQUFrQixDQUFFLFlBQVksRUFBRSxVQUFVO1FBQ3hDLElBQUk7WUFDQSx5Q0FBeUM7WUFDekMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQjtRQUNELE9BQU8sQ0FBQyxFQUFFO1lBQ04sZ0VBQWdFO1lBQ2hFLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFFRCxrQkFBa0I7UUFDbEIsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTNDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFRCxxQkFBcUIsQ0FBRSxZQUFZO1FBQy9CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFJLENBQUM7SUFDckQsQ0FBQztJQUVELG1CQUFtQixDQUFFLFlBQVk7UUFDN0IsTUFBTSxjQUFjLEdBQUcsa0JBQWtCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFeEQsSUFBSSxDQUFDLGNBQWM7WUFDZixPQUFPLElBQUksQ0FBQztRQUVoQixJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUMsQ0FBQztRQUUvQyxPQUFPLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBRSxLQUFLO1FBQ3ZCLElBQUksS0FBSyxZQUFZLG9CQUFpQjtZQUNsQyxPQUFPLEtBQUssQ0FBQztRQUVqQixNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEQsTUFBTSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEdBQUcsV0FBVyxDQUFDO1FBRTVELElBQUksV0FBVyxLQUFLLEtBQUs7WUFDckIsT0FBTyxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFekUsSUFBSSxDQUFDLE1BQU0sUUFBUSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQztZQUMvQyxNQUFNLElBQUksc0JBQVksQ0FBQyxzQkFBYyxDQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXBFLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtZQUN6QixLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVsQyx1QkFBUyxLQUFLLElBQUssV0FBVyxFQUFHO0lBQ3JDLENBQUM7SUFFRCxXQUFXLENBQUUsWUFBWSxFQUFFLGNBQWM7UUFDckMsWUFBWSxHQUFHLDZCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDLFlBQVksQ0FBQztRQUU1RCxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLElBQUksVUFBZSxDQUNuRCxJQUFJLHFCQUF5QixDQUFDLGNBQWMsRUFBRSxZQUFZLENBQUMsQ0FDOUQsQ0FBQztJQUNOLENBQUM7SUFFRCxjQUFjLENBQUUsWUFBWTtRQUN4QixZQUFZLEdBQUcsNkJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUMsWUFBWSxDQUFDO1FBRTVELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBRSxZQUFZO1FBQzNCLE1BQU0sa0JBQWtCLEdBQUcsNkJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDM0QsTUFBTSxVQUFVLEdBQVcsa0JBQWtCLENBQUMsVUFBVSxDQUFDO1FBRXpELFlBQVksR0FBRyxrQkFBa0IsQ0FBQyxZQUFZLENBQUM7UUFFL0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQztZQUMxQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQztZQUNqRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFdEQsSUFBSSxRQUFRO1lBQ1IsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRW5ELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxPQUFPO1FBQ0gsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdkYsQ0FBQztDQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQlVJTFRfSU5fUFJPVklERVJTIGZyb20gJy4vYnVpbHQtaW4nO1xuaW1wb3J0IEJyb3dzZXJQcm92aWRlclBsdWdpbkhvc3QgZnJvbSAnLi9wbHVnaW4taG9zdCc7XG5pbXBvcnQgcGFyc2VQcm92aWRlck5hbWUgZnJvbSAnLi9wYXJzZS1wcm92aWRlci1uYW1lJztcbmltcG9ydCBCcm93c2VyUHJvdmlkZXIgZnJvbSAnLi8nO1xuaW1wb3J0IEJyb3dzZXJDb25uZWN0aW9uIGZyb20gJy4uL2Nvbm5lY3Rpb24nO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuXG5jb25zdCBCUk9XU0VSX1BST1ZJREVSX1JFICAgICA9IC9eKFteOlxcc10rKTo/KC4qKT8kLztcbmNvbnN0IEJST1dTRVJfSU5GT19QUk9QRVJUSUVTID0gWydicm93c2VyTmFtZScsICdicm93c2VyT3B0aW9uJywgJ3Byb3ZpZGVyTmFtZScsICdwcm92aWRlciddO1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gICAgcHJvdmlkZXJzQ2FjaGU6IHt9LFxuXG4gICAgYXN5bmMgX2hhbmRsZVBhdGhBbmRDbWQgKGFsaWFzKSB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJOYW1lICAgPSBKU09OLnN0cmluZ2lmeShhbGlhcyk7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyTmFtZSAgPSAncGF0aCc7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyICAgICAgPSBhd2FpdCB0aGlzLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJPcHRpb24gPSBwcm92aWRlci5wbHVnaW4uZ2V0Q29uZmlnKGJyb3dzZXJOYW1lKTtcblxuICAgICAgICByZXR1cm4geyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSwgYnJvd3Nlck9wdGlvbiB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfcGFyc2VBbGlhc1N0cmluZyAoYWxpYXMpIHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJSZWdFeHBNYXRjaCA9IEJST1dTRVJfUFJPVklERVJfUkUuZXhlYyhhbGlhcyk7XG5cbiAgICAgICAgaWYgKCFwcm92aWRlclJlZ0V4cE1hdGNoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jYW5ub3RGaW5kQnJvd3NlciwgYWxpYXMpO1xuXG4gICAgICAgIGxldCBwcm92aWRlck5hbWUgID0gcHJvdmlkZXJSZWdFeHBNYXRjaFsxXTtcbiAgICAgICAgbGV0IGJyb3dzZXJOYW1lICAgPSBwcm92aWRlclJlZ0V4cE1hdGNoWzJdIHx8ICcnO1xuICAgICAgICBsZXQgYnJvd3Nlck9wdGlvbiA9IHt9O1xuXG4gICAgICAgIGxldCBwcm92aWRlciA9IGF3YWl0IHRoaXMuZ2V0UHJvdmlkZXIocHJvdmlkZXJOYW1lKTtcblxuICAgICAgICBpZiAoIXByb3ZpZGVyICYmIHByb3ZpZGVyUmVnRXhwTWF0Y2hbMl0pXG4gICAgICAgICAgICBwcm92aWRlciA9IGF3YWl0IHRoaXMuZ2V0UHJvdmlkZXIocHJvdmlkZXJOYW1lICsgJzonKTtcblxuICAgICAgICBpZiAoIXByb3ZpZGVyKSB7XG4gICAgICAgICAgICBwcm92aWRlck5hbWUgPSAnbG9jYWxseS1pbnN0YWxsZWQnO1xuICAgICAgICAgICAgcHJvdmlkZXIgICAgID0gYXdhaXQgdGhpcy5nZXRQcm92aWRlcihwcm92aWRlck5hbWUpO1xuICAgICAgICAgICAgYnJvd3Nlck5hbWUgID0gcHJvdmlkZXJSZWdFeHBNYXRjaFsxXSB8fCAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIGJyb3dzZXJPcHRpb24gPSBwcm92aWRlci5wbHVnaW4uZ2V0Q29uZmlnKGJyb3dzZXJOYW1lKTtcblxuICAgICAgICByZXR1cm4geyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSwgYnJvd3Nlck9wdGlvbiB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfcGFyc2VBbGlhcyAoYWxpYXMpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBhbGlhcyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIGlmIChCUk9XU0VSX0lORk9fUFJPUEVSVElFUy5ldmVyeShwcm9wZXJ0eSA9PiBwcm9wZXJ0eSBpbiBhbGlhcykpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsaWFzO1xuXG4gICAgICAgICAgICBpZiAoYWxpYXMucGF0aClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlUGF0aEFuZENtZChhbGlhcyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGFsaWFzID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUFsaWFzU3RyaW5nKGFsaWFzKTtcblxuICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdEZpbmRCcm93c2VyLCBhbGlhcyk7XG4gICAgfSxcblxuICAgIGFzeW5jIF9nZXRJbmZvRm9yQWxsQnJvd3Nlck5hbWVzIChwcm92aWRlciwgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgIGNvbnN0IGFsbEJyb3dzZXJOYW1lcyA9IHByb3ZpZGVyLmlzTXVsdGlCcm93c2VyID9cbiAgICAgICAgICAgIGF3YWl0IHByb3ZpZGVyLmdldEJyb3dzZXJMaXN0KCkgOlxuICAgICAgICAgICAgW107XG5cbiAgICAgICAgaWYgKCFhbGxCcm93c2VyTmFtZXMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIHsgcHJvdmlkZXIsIHByb3ZpZGVyTmFtZSwgYnJvd3Nlck5hbWU6ICcnIH07XG5cbiAgICAgICAgcmV0dXJuIGFsbEJyb3dzZXJOYW1lc1xuICAgICAgICAgICAgLm1hcChicm93c2VyTmFtZSA9PiAoeyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSB9KSk7XG4gICAgfSxcblxuICAgIF9nZXRQcm92aWRlck1vZHVsZSAocHJvdmlkZXJOYW1lLCBtb2R1bGVOYW1lKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBGaXJzdCwganVzdCBjaGVjayBpZiB0aGUgbW9kdWxlIGV4aXN0c1xuICAgICAgICAgICAgcmVxdWlyZS5yZXNvbHZlKG1vZHVsZU5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBNb2R1bGUgZG9lcyBub3QgZXhpc3QuIFJldHVybiBudWxsLCBhbmQgbGV0IHRoZSBjYWxsZXIgaGFuZGxlXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExvYWQgdGhlIG1vZHVsZVxuICAgICAgICBjb25zdCBwcm92aWRlck9iamVjdCA9IHJlcXVpcmUobW9kdWxlTmFtZSk7XG5cbiAgICAgICAgdGhpcy5hZGRQcm92aWRlcihwcm92aWRlck5hbWUsIHByb3ZpZGVyT2JqZWN0KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByb3ZpZGVyRnJvbUNhY2hlKHByb3ZpZGVyTmFtZSk7XG4gICAgfSxcblxuICAgIF9nZXRQcm92aWRlckZyb21DYWNoZSAocHJvdmlkZXJOYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc0NhY2hlW3Byb3ZpZGVyTmFtZV0gfHwgbnVsbDtcbiAgICB9LFxuXG4gICAgX2dldEJ1aWx0aW5Qcm92aWRlciAocHJvdmlkZXJOYW1lKSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyT2JqZWN0ID0gQlVJTFRfSU5fUFJPVklERVJTW3Byb3ZpZGVyTmFtZV07XG5cbiAgICAgICAgaWYgKCFwcm92aWRlck9iamVjdClcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIHRoaXMuYWRkUHJvdmlkZXIocHJvdmlkZXJOYW1lLCBwcm92aWRlck9iamVjdCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByb3ZpZGVyRnJvbUNhY2hlKHByb3ZpZGVyTmFtZSk7XG4gICAgfSxcblxuICAgIGFzeW5jIGdldEJyb3dzZXJJbmZvIChhbGlhcykge1xuICAgICAgICBpZiAoYWxpYXMgaW5zdGFuY2VvZiBCcm93c2VyQ29ubmVjdGlvbilcbiAgICAgICAgICAgIHJldHVybiBhbGlhcztcblxuICAgICAgICBjb25zdCBicm93c2VySW5mbyA9IGF3YWl0IHRoaXMuX3BhcnNlQWxpYXMoYWxpYXMpO1xuXG4gICAgICAgIGNvbnN0IHsgcHJvdmlkZXIsIHByb3ZpZGVyTmFtZSwgYnJvd3Nlck5hbWUgfSA9IGJyb3dzZXJJbmZvO1xuXG4gICAgICAgIGlmIChicm93c2VyTmFtZSA9PT0gJ2FsbCcpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0SW5mb0ZvckFsbEJyb3dzZXJOYW1lcyhwcm92aWRlciwgcHJvdmlkZXJOYW1lKTtcblxuICAgICAgICBpZiAoIWF3YWl0IHByb3ZpZGVyLmlzVmFsaWRCcm93c2VyTmFtZShicm93c2VyTmFtZSkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdEZpbmRCcm93c2VyLCBhbGlhcyk7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBhbGlhcyAhPT0gJ3N0cmluZycpXG4gICAgICAgICAgICBhbGlhcyA9IEpTT04uc3RyaW5naWZ5KGFsaWFzKTtcblxuICAgICAgICByZXR1cm4geyBhbGlhcywgLi4uYnJvd3NlckluZm8gfTtcbiAgICB9LFxuXG4gICAgYWRkUHJvdmlkZXIgKHByb3ZpZGVyTmFtZSwgcHJvdmlkZXJPYmplY3QpIHtcbiAgICAgICAgcHJvdmlkZXJOYW1lID0gcGFyc2VQcm92aWRlck5hbWUocHJvdmlkZXJOYW1lKS5wcm92aWRlck5hbWU7XG5cbiAgICAgICAgdGhpcy5wcm92aWRlcnNDYWNoZVtwcm92aWRlck5hbWVdID0gbmV3IEJyb3dzZXJQcm92aWRlcihcbiAgICAgICAgICAgIG5ldyBCcm93c2VyUHJvdmlkZXJQbHVnaW5Ib3N0KHByb3ZpZGVyT2JqZWN0LCBwcm92aWRlck5hbWUpXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIHJlbW92ZVByb3ZpZGVyIChwcm92aWRlck5hbWUpIHtcbiAgICAgICAgcHJvdmlkZXJOYW1lID0gcGFyc2VQcm92aWRlck5hbWUocHJvdmlkZXJOYW1lKS5wcm92aWRlck5hbWU7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMucHJvdmlkZXJzQ2FjaGVbcHJvdmlkZXJOYW1lXTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0UHJvdmlkZXIgKHByb3ZpZGVyTmFtZSkge1xuICAgICAgICBjb25zdCBwYXJzZWRQcm92aWRlck5hbWUgPSBwYXJzZVByb3ZpZGVyTmFtZShwcm92aWRlck5hbWUpO1xuICAgICAgICBjb25zdCBtb2R1bGVOYW1lICAgICAgICAgPSBwYXJzZWRQcm92aWRlck5hbWUubW9kdWxlTmFtZTtcblxuICAgICAgICBwcm92aWRlck5hbWUgPSBwYXJzZWRQcm92aWRlck5hbWUucHJvdmlkZXJOYW1lO1xuXG4gICAgICAgIGNvbnN0IHByb3ZpZGVyID0gdGhpcy5fZ2V0UHJvdmlkZXJGcm9tQ2FjaGUocHJvdmlkZXJOYW1lKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRQcm92aWRlck1vZHVsZShwcm92aWRlck5hbWUsIG1vZHVsZU5hbWUpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldEJ1aWx0aW5Qcm92aWRlcihwcm92aWRlck5hbWUpO1xuXG4gICAgICAgIGlmIChwcm92aWRlcilcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJzQ2FjaGVbcHJvdmlkZXJOYW1lXS5pbml0KCk7XG5cbiAgICAgICAgcmV0dXJuIHByb3ZpZGVyO1xuICAgIH0sXG5cbiAgICBkaXNwb3NlICgpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKE9iamVjdC52YWx1ZXModGhpcy5wcm92aWRlcnNDYWNoZSkubWFwKGl0ZW0gPT4gaXRlbS5kaXNwb3NlKCkpKTtcbiAgICB9XG59O1xuIl19