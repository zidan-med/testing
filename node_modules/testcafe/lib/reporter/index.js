"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const is_stream_1 = require("is-stream");
const plugin_host_1 = __importDefault(require("./plugin-host"));
const plugin_methods_1 = __importDefault(require("./plugin-methods"));
const format_command_1 = __importDefault(require("./command/format-command"));
const get_browser_1 = __importDefault(require("../utils/get-browser"));
const runtime_1 = require("../errors/runtime");
class Reporter {
    constructor(plugin, task, outStream, name) {
        this.plugin = new plugin_host_1.default(plugin, outStream, name);
        this.task = task;
        this.disposed = false;
        this.passed = 0;
        this.failed = 0;
        this.skipped = 0;
        this.testCount = task.tests.filter(test => !test.skip).length;
        this.reportQueue = Reporter._createReportQueue(task);
        this.stopOnFirstFail = task.opts.stopOnFirstFail;
        this.outStream = outStream;
        this.pendingTaskDonePromise = Reporter._createPendingPromise();
        this._assignTaskEventHandlers();
    }
    static _isSpecialStream(stream) {
        return stream.isTTY || stream === process.stdout || stream === process.stderr;
    }
    static _createPendingPromise() {
        let resolver = null;
        const promise = new Promise(resolve => {
            resolver = resolve;
        });
        promise.resolve = resolver;
        return promise;
    }
    static _createReportItem(test, runsPerTest) {
        return {
            fixture: test.fixture,
            test: test,
            testRunIds: [],
            screenshotPath: null,
            screenshots: [],
            videos: [],
            quarantine: null,
            errs: [],
            warnings: [],
            unstable: false,
            startTime: null,
            testRunInfo: null,
            pendingRuns: runsPerTest,
            pendingStarts: runsPerTest,
            pendingTestRunDonePromise: Reporter._createPendingPromise(),
            pendingTestRunStartPromise: Reporter._createPendingPromise(),
            browsers: []
        };
    }
    static _createReportQueue(task) {
        const runsPerTest = task.browserConnectionGroups.length;
        return task.tests.map(test => Reporter._createReportItem(test, runsPerTest));
    }
    static _createTestRunInfo(reportItem) {
        return {
            errs: lodash_1.sortBy(reportItem.errs, ['userAgent', 'code']),
            warnings: reportItem.warnings,
            durationMs: +new Date() - reportItem.startTime,
            unstable: reportItem.unstable,
            screenshotPath: reportItem.screenshotPath,
            screenshots: reportItem.screenshots,
            videos: reportItem.videos,
            quarantine: reportItem.quarantine,
            skipped: reportItem.test.skip,
            browsers: reportItem.browsers,
            testId: reportItem.test.id
        };
    }
    _getReportItemForTestRun(testRun) {
        return lodash_1.find(this.reportQueue, i => i.test === testRun.test);
    }
    async _shiftReportQueue() {
        let currentFixture = null;
        let nextReportItem = null;
        let reportItem = null;
        while (this.reportQueue.length && this.reportQueue[0].testRunInfo) {
            reportItem = this.reportQueue.shift();
            currentFixture = reportItem.fixture;
            // NOTE: here we assume that tests are sorted by fixture.
            // Therefore, if the next report item has a different
            // fixture, we can report this fixture start.
            nextReportItem = this.reportQueue[0];
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestDone,
                args: [
                    reportItem.test.name,
                    reportItem.testRunInfo,
                    reportItem.test.meta
                ]
            });
            if (!nextReportItem)
                continue;
            if (nextReportItem.fixture === currentFixture)
                continue;
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportFixtureStart,
                args: [
                    nextReportItem.fixture.name,
                    nextReportItem.fixture.path,
                    nextReportItem.fixture.meta
                ]
            });
        }
    }
    async _resolveReportItem(reportItem, testRun) {
        if (this.task.screenshots.hasCapturedFor(testRun.test)) {
            reportItem.screenshotPath = this.task.screenshots.getPathFor(testRun.test);
            reportItem.screenshots = this.task.screenshots.getScreenshotsInfo(testRun.test);
        }
        if (this.task.videos)
            reportItem.videos = this.task.videos.getTestVideos(reportItem.test.id);
        if (testRun.quarantine) {
            reportItem.quarantine = testRun.quarantine.attempts.reduce((result, errors, index) => {
                const passed = !errors.length;
                const quarantineAttempt = index + 1;
                result[quarantineAttempt] = { passed };
                return result;
            }, {});
        }
        if (!reportItem.testRunInfo) {
            reportItem.testRunInfo = Reporter._createTestRunInfo(reportItem);
            if (reportItem.test.skip)
                this.skipped++;
            else if (reportItem.errs.length)
                this.failed++;
            else
                this.passed++;
        }
        await this._shiftReportQueue();
        reportItem.pendingTestRunDonePromise.resolve();
    }
    _prepareReportTestActionEventArgs({ command, duration, result, testRun, err }) {
        const args = {};
        if (err)
            args.err = err;
        if (typeof duration === 'number')
            args.duration = duration;
        return Object.assign(args, {
            testRunId: testRun.id,
            test: {
                id: testRun.test.id,
                name: testRun.test.name,
                phase: testRun.phase,
            },
            fixture: {
                name: testRun.test.fixture.name,
                id: testRun.test.fixture.id
            },
            command: format_command_1.default(command, result),
            browser: get_browser_1.default(testRun.browserConnection),
        });
    }
    async dispatchToPlugin({ method, args = [] }) {
        try {
            // @ts-ignore
            await this.plugin[method](...args);
        }
        catch (originalError) {
            const uncaughtError = new runtime_1.ReporterPluginError({
                name: this.plugin.name,
                method,
                originalError
            });
            this.task.emit('error', uncaughtError);
        }
    }
    async _onceTaskStartHandler() {
        const startTime = new Date();
        const userAgents = this.task.browserConnectionGroups.map(group => group[0].userAgent);
        const first = this.reportQueue[0];
        const taskProperties = {
            configuration: this.task.opts
        };
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportTaskStart,
            args: [
                startTime,
                userAgents,
                this.testCount,
                this.task.testStructure,
                taskProperties
            ]
        });
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportFixtureStart,
            args: [
                first.fixture.name,
                first.fixture.path,
                first.fixture.meta
            ]
        });
    }
    async _onTaskTestRunStartHandler(testRun) {
        const reportItem = this._getReportItemForTestRun(testRun);
        reportItem.testRunIds.push(testRun.id);
        if (!reportItem.startTime)
            reportItem.startTime = +new Date();
        reportItem.pendingStarts--;
        if (!reportItem.pendingStarts) {
            // @ts-ignore
            if (this.plugin.reportTestStart) {
                const testStartInfo = { testRunIds: reportItem.testRunIds, testId: reportItem.test.id };
                await this.dispatchToPlugin({
                    method: plugin_methods_1.default.reportTestStart,
                    args: [
                        reportItem.test.name,
                        reportItem.test.meta,
                        testStartInfo
                    ]
                });
            }
            reportItem.pendingTestRunStartPromise.resolve();
        }
        return reportItem.pendingTestRunStartPromise;
    }
    async _onTaskTestRunDoneHandler(testRun) {
        const reportItem = this._getReportItemForTestRun(testRun);
        const isTestRunStoppedTaskExecution = !!testRun.errs.length && this.stopOnFirstFail;
        reportItem.pendingRuns = isTestRunStoppedTaskExecution ? 0 : reportItem.pendingRuns - 1;
        reportItem.unstable = reportItem.unstable || testRun.unstable;
        reportItem.errs = reportItem.errs.concat(testRun.errs);
        reportItem.warnings = testRun.warningLog ? lodash_1.union(reportItem.warnings, testRun.warningLog.messages) : [];
        reportItem.browsers.push(Object.assign({ testRunId: testRun.id }, get_browser_1.default(testRun.browserConnection)));
        if (!reportItem.pendingRuns)
            await this._resolveReportItem(reportItem, testRun);
        await reportItem.pendingTestRunDonePromise;
    }
    async _onTaskTestActionStart(_a) {
        var { apiActionName } = _a, restArgs = __rest(_a, ["apiActionName"]);
        // @ts-ignore
        if (this.plugin.reportTestActionStart) {
            restArgs = this._prepareReportTestActionEventArgs(restArgs);
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestActionStart,
                args: [
                    apiActionName,
                    restArgs
                ]
            });
        }
    }
    async _onTaskTestActionDone(_a) {
        var { apiActionName } = _a, restArgs = __rest(_a, ["apiActionName"]);
        // @ts-ignore
        if (this.plugin.reportTestActionDone) {
            restArgs = this._prepareReportTestActionEventArgs(restArgs);
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestActionDone,
                args: [
                    apiActionName,
                    restArgs
                ]
            });
        }
    }
    async _onceTaskDoneHandler() {
        const endTime = new Date();
        const result = {
            passedCount: this.passed,
            failedCount: this.failed,
            skippedCount: this.skipped
        };
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportTaskDone,
            args: [
                endTime,
                this.passed,
                this.task.warningLog.messages,
                result
            ]
        });
        this.pendingTaskDonePromise.resolve();
    }
    _assignTaskEventHandlers() {
        const task = this.task;
        task.once('start', async () => await this._onceTaskStartHandler());
        task.on('test-run-start', async (testRun) => await this._onTaskTestRunStartHandler(testRun));
        task.on('test-run-done', async (testRun) => await this._onTaskTestRunDoneHandler(testRun));
        task.on('test-action-start', async (e) => await this._onTaskTestActionStart(e));
        task.on('test-action-done', async (e) => await this._onTaskTestActionDone(e));
        task.once('done', async () => await this._onceTaskDoneHandler());
    }
    async dispose() {
        if (this.disposed)
            return Promise.resolve();
        this.disposed = true;
        if (!this.outStream || Reporter._isSpecialStream(this.outStream) || !is_stream_1.writable(this.outStream))
            return Promise.resolve();
        const streamFinishedPromise = new Promise(resolve => {
            this.outStream.once('finish', resolve);
            this.outStream.once('error', resolve);
        });
        this.outStream.end();
        return streamFinishedPromise;
    }
}
exports.default = Reporter;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVwb3J0ZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1DQUlnQjtBQUVoQix5Q0FBeUQ7QUFDekQsZ0VBQStDO0FBQy9DLHNFQUFvRDtBQUNwRCw4RUFBcUQ7QUFDckQsdUVBQThDO0FBQzlDLCtDQUF3RDtBQW9FeEQsTUFBcUIsUUFBUTtJQWF6QixZQUFvQixNQUEwQixFQUFFLElBQVUsRUFBRSxTQUFtQixFQUFFLElBQVk7UUFDekYsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHFCQUFrQixDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLElBQUksR0FBSyxJQUFJLENBQUM7UUFFbkIsSUFBSSxDQUFDLFFBQVEsR0FBaUIsS0FBSyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQW1CLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsTUFBTSxHQUFtQixDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBa0IsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQWdCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQzNFLElBQUksQ0FBQyxXQUFXLEdBQWMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxlQUFlLEdBQVUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUEwQixDQUFDO1FBQ25FLElBQUksQ0FBQyxTQUFTLEdBQWdCLFNBQVMsQ0FBQztRQUN4QyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsUUFBUSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFL0QsSUFBSSxDQUFDLHdCQUF3QixF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SUFBSSxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsb0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNqRyxPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUU3QixNQUFNLHFCQUFxQixHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRXJCLE9BQU8scUJBQXFCLENBQUM7SUFDakMsQ0FBQztDQUNKO0FBdlhELDJCQXVYQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgZmluZCxcbiAgICBzb3J0QnksXG4gICAgdW5pb25cbn0gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgd3JpdGFibGUgYXMgaXNXcml0YWJsZVN0cmVhbSB9IGZyb20gJ2lzLXN0cmVhbSc7XG5pbXBvcnQgUmVwb3J0ZXJQbHVnaW5Ib3N0IGZyb20gJy4vcGx1Z2luLWhvc3QnO1xuaW1wb3J0IFJlcG9ydGVyUGx1Z2luTWV0aG9kIGZyb20gJy4vcGx1Z2luLW1ldGhvZHMnO1xuaW1wb3J0IGZvcm1hdENvbW1hbmQgZnJvbSAnLi9jb21tYW5kL2Zvcm1hdC1jb21tYW5kJztcbmltcG9ydCBnZXRCcm93c2VyIGZyb20gJy4uL3V0aWxzL2dldC1icm93c2VyJztcbmltcG9ydCB7IFJlcG9ydGVyUGx1Z2luRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgVGFzayBmcm9tICcuLi9ydW5uZXIvdGFzayc7XG5pbXBvcnQgeyBXcml0YWJsZSB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBXcml0ZVN0cmVhbSB9IGZyb20gJ3R0eSc7XG5pbXBvcnQgVGVzdFJ1biBmcm9tICcuLi90ZXN0LXJ1bic7XG5pbXBvcnQgVGVzdCBmcm9tICcuLi9hcGkvc3RydWN0dXJlL3Rlc3QnO1xuaW1wb3J0IEZpeHR1cmUgZnJvbSAnLi4vYXBpL3N0cnVjdHVyZS9maXh0dXJlJztcbmltcG9ydCBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXIgZnJvbSAnLi4vZXJyb3JzL3Rlc3QtcnVuL2Zvcm1hdHRhYmxlLWFkYXB0ZXInO1xuaW1wb3J0IENvbW1hbmRCYXNlIGZyb20gJy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2Jhc2UnO1xuXG5cbmludGVyZmFjZSBQZW5kaW5nUHJvbWlzZSB7XG4gICAgcmVzb2x2ZTogRnVuY3Rpb24gfCBudWxsO1xuICAgIHRoZW46IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgUmVwb3J0SXRlbSB7XG4gICAgZml4dHVyZTogRml4dHVyZTtcbiAgICB0ZXN0OiBUZXN0O1xuICAgIHRlc3RSdW5JZHM6IHN0cmluZ1tdO1xuICAgIHNjcmVlbnNob3RQYXRoOiBudWxsIHwgc3RyaW5nO1xuICAgIHNjcmVlbnNob3RzOiB1bmtub3duW107XG4gICAgdmlkZW9zOiB1bmtub3duW107XG4gICAgcXVhcmFudGluZTogbnVsbCB8IFJlY29yZDxzdHJpbmcsIG9iamVjdD47XG4gICAgZXJyczogVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyW107XG4gICAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICAgIHVuc3RhYmxlOiBib29sZWFuO1xuICAgIHN0YXJ0VGltZTogbnVsbCB8IG51bWJlcjtcbiAgICB0ZXN0UnVuSW5mbzogbnVsbCB8IFRlc3RSdW5JbmZvO1xuICAgIHBlbmRpbmdSdW5zOiBudW1iZXI7XG4gICAgcGVuZGluZ1N0YXJ0czogbnVtYmVyO1xuICAgIHBlbmRpbmdUZXN0UnVuRG9uZVByb21pc2U6IFBlbmRpbmdQcm9taXNlO1xuICAgIHBlbmRpbmdUZXN0UnVuU3RhcnRQcm9taXNlOiBQZW5kaW5nUHJvbWlzZTtcbiAgICBicm93c2VyczogdW5rbm93bltdO1xufVxuXG5pbnRlcmZhY2UgVGVzdFJ1bkluZm8ge1xuICAgIGVycnM6IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlcltdO1xuICAgIHdhcm5pbmdzOiBzdHJpbmdbXTtcbiAgICBkdXJhdGlvbk1zOiBudW1iZXI7XG4gICAgdW5zdGFibGU6IGJvb2xlYW47XG4gICAgc2NyZWVuc2hvdFBhdGg6IHN0cmluZztcbiAgICBzY3JlZW5zaG90czogdW5rbm93bjtcbiAgICB2aWRlb3M6IHVua25vd247XG4gICAgcXVhcmFudGluZTogdW5rbm93bjtcbiAgICBza2lwcGVkOiBib29sZWFuO1xuICAgIGJyb3dzZXJzOiB1bmtub3duW107XG4gICAgdGVzdElkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBQbHVnaW5NZXRob2RBcmd1bWVudHMge1xuICAgIG1ldGhvZDogc3RyaW5nO1xuICAgIGFyZ3M6IHVua25vd25bXTtcbn1cblxuaW50ZXJmYWNlIFJlcG9ydFRlc3RBY3Rpb25FdmVudEFyZ3VtZW50cyB7XG4gICAgY29tbWFuZDogQ29tbWFuZEJhc2U7XG4gICAgZHVyYXRpb246IG51bWJlcjtcbiAgICByZXN1bHQ6IHVua25vd247XG4gICAgdGVzdFJ1bjogVGVzdFJ1bjtcbiAgICBlcnI6IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlcjtcbn1cblxuaW50ZXJmYWNlIFJlcG9ydFRhc2tBY3Rpb25FdmVudEFyZ3VtZW50cyB7XG4gICAgYXBpQWN0aW9uTmFtZTogc3RyaW5nO1xuICAgIHJlc3RBcmdzOiBvYmplY3Q7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlcG9ydGVyIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGx1Z2luOiBSZXBvcnRlclBsdWdpbkhvc3Q7XG4gICAgcHVibGljIHJlYWRvbmx5IHRhc2s6IFRhc2s7XG4gICAgcHVibGljIGRpc3Bvc2VkOiBib29sZWFuO1xuICAgIHB1YmxpYyBwYXNzZWQ6IG51bWJlcjtcbiAgICBwdWJsaWMgZmFpbGVkOiBudW1iZXI7XG4gICAgcHVibGljIHNraXBwZWQ6IG51bWJlcjtcbiAgICBwdWJsaWMgdGVzdENvdW50OiBudW1iZXI7XG4gICAgcHVibGljIHJlYWRvbmx5IHJlcG9ydFF1ZXVlOiBSZXBvcnRJdGVtW107XG4gICAgcHVibGljIHJlYWRvbmx5IHN0b3BPbkZpcnN0RmFpbDogYm9vbGVhbjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgb3V0U3RyZWFtOiBXcml0YWJsZTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGVuZGluZ1Rhc2tEb25lUHJvbWlzZTogUGVuZGluZ1Byb21pc2U7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKHBsdWdpbjogUmVwb3J0ZXJQbHVnaW5Ib3N0LCB0YXNrOiBUYXNrLCBvdXRTdHJlYW06IFdyaXRhYmxlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5wbHVnaW4gPSBuZXcgUmVwb3J0ZXJQbHVnaW5Ib3N0KHBsdWdpbiwgb3V0U3RyZWFtLCBuYW1lKTtcbiAgICAgICAgdGhpcy50YXNrICAgPSB0YXNrO1xuXG4gICAgICAgIHRoaXMuZGlzcG9zZWQgICAgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBhc3NlZCAgICAgICAgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLmZhaWxlZCAgICAgICAgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLnNraXBwZWQgICAgICAgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLnRlc3RDb3VudCAgICAgICAgICAgICAgPSB0YXNrLnRlc3RzLmZpbHRlcih0ZXN0ID0+ICF0ZXN0LnNraXApLmxlbmd0aDtcbiAgICAgICAgdGhpcy5yZXBvcnRRdWV1ZSAgICAgICAgICAgID0gUmVwb3J0ZXIuX2NyZWF0ZVJlcG9ydFF1ZXVlKHRhc2spO1xuICAgICAgICB0aGlzLnN0b3BPbkZpcnN0RmFpbCAgICAgICAgPSB0YXNrLm9wdHMuc3RvcE9uRmlyc3RGYWlsIGFzIGJvb2xlYW47XG4gICAgICAgIHRoaXMub3V0U3RyZWFtICAgICAgICAgICAgICA9IG91dFN0cmVhbTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza0RvbmVQcm9taXNlID0gUmVwb3J0ZXIuX2NyZWF0ZVBlbmRpbmdQcm9taXNlKCk7XG5cbiAgICAgICAgdGhpcy5fYXNzaWduVGFza0V2ZW50SGFuZGxlcnMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfaXNTcGVjaWFsU3RyZWFtIChzdHJlYW06IFdyaXRhYmxlKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoc3RyZWFtIGFzIFdyaXRlU3RyZWFtKS5pc1RUWSB8fCBzdHJlYW0gPT09IHByb2Nlc3Muc3Rkb3V0IHx8IHN0cmVhbSA9PT0gcHJvY2Vzcy5zdGRlcnI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2NyZWF0ZVBlbmRpbmdQcm9taXNlICgpOiBQZW5kaW5nUHJvbWlzZSB7XG4gICAgICAgIGxldCByZXNvbHZlciA9IG51bGw7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZXIgPSByZXNvbHZlO1xuICAgICAgICB9KSBhcyB1bmtub3duIGFzIFBlbmRpbmdQcm9taXNlO1xuXG4gICAgICAgIHByb21pc2UucmVzb2x2ZSA9IHJlc29sdmVyO1xuXG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9jcmVhdGVSZXBvcnRJdGVtICh0ZXN0OiBUZXN0LCBydW5zUGVyVGVzdDogbnVtYmVyKTogUmVwb3J0SXRlbSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmaXh0dXJlOiAgICAgICAgICAgICAgICAgICAgdGVzdC5maXh0dXJlLFxuICAgICAgICAgICAgdGVzdDogICAgICAgICAgICAgICAgICAgICAgIHRlc3QsXG4gICAgICAgICAgICB0ZXN0UnVuSWRzOiAgICAgICAgICAgICAgICAgW10sXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIHNjcmVlbnNob3RzOiAgICAgICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHZpZGVvczogICAgICAgICAgICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHF1YXJhbnRpbmU6ICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgZXJyczogICAgICAgICAgICAgICAgICAgICAgIFtdLFxuICAgICAgICAgICAgd2FybmluZ3M6ICAgICAgICAgICAgICAgICAgIFtdLFxuICAgICAgICAgICAgdW5zdGFibGU6ICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgc3RhcnRUaW1lOiAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICB0ZXN0UnVuSW5mbzogICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIHBlbmRpbmdSdW5zOiAgICAgICAgICAgICAgICBydW5zUGVyVGVzdCxcbiAgICAgICAgICAgIHBlbmRpbmdTdGFydHM6ICAgICAgICAgICAgICBydW5zUGVyVGVzdCxcbiAgICAgICAgICAgIHBlbmRpbmdUZXN0UnVuRG9uZVByb21pc2U6ICBSZXBvcnRlci5fY3JlYXRlUGVuZGluZ1Byb21pc2UoKSxcbiAgICAgICAgICAgIHBlbmRpbmdUZXN0UnVuU3RhcnRQcm9taXNlOiBSZXBvcnRlci5fY3JlYXRlUGVuZGluZ1Byb21pc2UoKSxcbiAgICAgICAgICAgIGJyb3dzZXJzOiAgICAgICAgICAgICAgICAgICBbXVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9jcmVhdGVSZXBvcnRRdWV1ZSAodGFzazogVGFzayk6IFJlcG9ydEl0ZW1bXSB7XG4gICAgICAgIGNvbnN0IHJ1bnNQZXJUZXN0ID0gdGFzay5icm93c2VyQ29ubmVjdGlvbkdyb3Vwcy5sZW5ndGg7XG5cbiAgICAgICAgcmV0dXJuIHRhc2sudGVzdHMubWFwKHRlc3QgPT4gUmVwb3J0ZXIuX2NyZWF0ZVJlcG9ydEl0ZW0odGVzdCwgcnVuc1BlclRlc3QpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfY3JlYXRlVGVzdFJ1bkluZm8gKHJlcG9ydEl0ZW06IFJlcG9ydEl0ZW0pOiBUZXN0UnVuSW5mbyB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlcnJzOiAgICAgICAgICAgc29ydEJ5KHJlcG9ydEl0ZW0uZXJycywgWyd1c2VyQWdlbnQnLCAnY29kZSddKSxcbiAgICAgICAgICAgIHdhcm5pbmdzOiAgICAgICByZXBvcnRJdGVtLndhcm5pbmdzLFxuICAgICAgICAgICAgZHVyYXRpb25NczogICAgICtuZXcgRGF0ZSgpIC0gKHJlcG9ydEl0ZW0uc3RhcnRUaW1lIGFzIG51bWJlciksIC8vZXNsaW50LWRpc2FibGUtbGluZSAgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4dHJhLXBhcmVuc1xuICAgICAgICAgICAgdW5zdGFibGU6ICAgICAgIHJlcG9ydEl0ZW0udW5zdGFibGUsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogcmVwb3J0SXRlbS5zY3JlZW5zaG90UGF0aCBhcyBzdHJpbmcsXG4gICAgICAgICAgICBzY3JlZW5zaG90czogICAgcmVwb3J0SXRlbS5zY3JlZW5zaG90cyxcbiAgICAgICAgICAgIHZpZGVvczogICAgICAgICByZXBvcnRJdGVtLnZpZGVvcyxcbiAgICAgICAgICAgIHF1YXJhbnRpbmU6ICAgICByZXBvcnRJdGVtLnF1YXJhbnRpbmUsXG4gICAgICAgICAgICBza2lwcGVkOiAgICAgICAgcmVwb3J0SXRlbS50ZXN0LnNraXAsXG4gICAgICAgICAgICBicm93c2VyczogICAgICAgcmVwb3J0SXRlbS5icm93c2VycyxcbiAgICAgICAgICAgIHRlc3RJZDogICAgICAgICByZXBvcnRJdGVtLnRlc3QuaWRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1biAodGVzdFJ1bjogVGVzdFJ1bik6IFJlcG9ydEl0ZW0gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gZmluZCh0aGlzLnJlcG9ydFF1ZXVlLCBpID0+IGkudGVzdCA9PT0gdGVzdFJ1bi50ZXN0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9zaGlmdFJlcG9ydFF1ZXVlICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgbGV0IGN1cnJlbnRGaXh0dXJlID0gbnVsbDtcbiAgICAgICAgbGV0IG5leHRSZXBvcnRJdGVtID0gbnVsbDtcbiAgICAgICAgbGV0IHJlcG9ydEl0ZW0gICAgID0gbnVsbDtcblxuICAgICAgICB3aGlsZSAodGhpcy5yZXBvcnRRdWV1ZS5sZW5ndGggJiYgdGhpcy5yZXBvcnRRdWV1ZVswXS50ZXN0UnVuSW5mbykge1xuICAgICAgICAgICAgcmVwb3J0SXRlbSAgICAgPSB0aGlzLnJlcG9ydFF1ZXVlLnNoaWZ0KCkgYXMgUmVwb3J0SXRlbTtcbiAgICAgICAgICAgIGN1cnJlbnRGaXh0dXJlID0gcmVwb3J0SXRlbS5maXh0dXJlO1xuXG4gICAgICAgICAgICAvLyBOT1RFOiBoZXJlIHdlIGFzc3VtZSB0aGF0IHRlc3RzIGFyZSBzb3J0ZWQgYnkgZml4dHVyZS5cbiAgICAgICAgICAgIC8vIFRoZXJlZm9yZSwgaWYgdGhlIG5leHQgcmVwb3J0IGl0ZW0gaGFzIGEgZGlmZmVyZW50XG4gICAgICAgICAgICAvLyBmaXh0dXJlLCB3ZSBjYW4gcmVwb3J0IHRoaXMgZml4dHVyZSBzdGFydC5cbiAgICAgICAgICAgIG5leHRSZXBvcnRJdGVtID0gdGhpcy5yZXBvcnRRdWV1ZVswXTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFJlcG9ydGVyUGx1Z2luTWV0aG9kLnJlcG9ydFRlc3REb25lLFxuICAgICAgICAgICAgICAgIGFyZ3M6ICAgW1xuICAgICAgICAgICAgICAgICAgICByZXBvcnRJdGVtLnRlc3QubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0UnVuSW5mbyxcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0Lm1ldGFcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFuZXh0UmVwb3J0SXRlbSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgaWYgKG5leHRSZXBvcnRJdGVtLmZpeHR1cmUgPT09IGN1cnJlbnRGaXh0dXJlKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoVG9QbHVnaW4oe1xuICAgICAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0Rml4dHVyZVN0YXJ0LFxuICAgICAgICAgICAgICAgIGFyZ3M6ICAgW1xuICAgICAgICAgICAgICAgICAgICBuZXh0UmVwb3J0SXRlbS5maXh0dXJlLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIG5leHRSZXBvcnRJdGVtLmZpeHR1cmUucGF0aCxcbiAgICAgICAgICAgICAgICAgICAgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZS5tZXRhXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9yZXNvbHZlUmVwb3J0SXRlbSAocmVwb3J0SXRlbTogUmVwb3J0SXRlbSwgdGVzdFJ1bjogVGVzdFJ1bik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy50YXNrLnNjcmVlbnNob3RzLmhhc0NhcHR1cmVkRm9yKHRlc3RSdW4udGVzdCkpIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdFBhdGggPSB0aGlzLnRhc2suc2NyZWVuc2hvdHMuZ2V0UGF0aEZvcih0ZXN0UnVuLnRlc3QpO1xuICAgICAgICAgICAgcmVwb3J0SXRlbS5zY3JlZW5zaG90cyAgICA9IHRoaXMudGFzay5zY3JlZW5zaG90cy5nZXRTY3JlZW5zaG90c0luZm8odGVzdFJ1bi50ZXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnRhc2sudmlkZW9zKVxuICAgICAgICAgICAgcmVwb3J0SXRlbS52aWRlb3MgPSB0aGlzLnRhc2sudmlkZW9zLmdldFRlc3RWaWRlb3MocmVwb3J0SXRlbS50ZXN0LmlkKTtcblxuICAgICAgICBpZiAodGVzdFJ1bi5xdWFyYW50aW5lKSB7XG4gICAgICAgICAgICByZXBvcnRJdGVtLnF1YXJhbnRpbmUgPSB0ZXN0UnVuLnF1YXJhbnRpbmUuYXR0ZW1wdHMucmVkdWNlKChyZXN1bHQ6IFJlY29yZDxzdHJpbmcsIG9iamVjdD4sIGVycm9yczogVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyW10sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXNzZWQgICAgICAgICAgICA9ICFlcnJvcnMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIGNvbnN0IHF1YXJhbnRpbmVBdHRlbXB0ID0gaW5kZXggKyAxO1xuXG4gICAgICAgICAgICAgICAgcmVzdWx0W3F1YXJhbnRpbmVBdHRlbXB0XSA9IHsgcGFzc2VkIH07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSwge30pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFyZXBvcnRJdGVtLnRlc3RSdW5JbmZvKSB7XG4gICAgICAgICAgICByZXBvcnRJdGVtLnRlc3RSdW5JbmZvID0gUmVwb3J0ZXIuX2NyZWF0ZVRlc3RSdW5JbmZvKHJlcG9ydEl0ZW0pO1xuXG4gICAgICAgICAgICBpZiAocmVwb3J0SXRlbS50ZXN0LnNraXApXG4gICAgICAgICAgICAgICAgdGhpcy5za2lwcGVkKys7XG4gICAgICAgICAgICBlbHNlIGlmIChyZXBvcnRJdGVtLmVycnMubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHRoaXMuZmFpbGVkKys7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgdGhpcy5wYXNzZWQrKztcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NoaWZ0UmVwb3J0UXVldWUoKTtcblxuICAgICAgICAocmVwb3J0SXRlbS5wZW5kaW5nVGVzdFJ1bkRvbmVQcm9taXNlLnJlc29sdmUgYXMgRnVuY3Rpb24pKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcHJlcGFyZVJlcG9ydFRlc3RBY3Rpb25FdmVudEFyZ3MgKHsgY29tbWFuZCwgZHVyYXRpb24sIHJlc3VsdCwgdGVzdFJ1biwgZXJyIH06IFJlcG9ydFRlc3RBY3Rpb25FdmVudEFyZ3VtZW50cyk6IGFueSB7XG4gICAgICAgIGNvbnN0IGFyZ3M6IGFueSA9IHt9O1xuXG4gICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICBhcmdzLmVyciA9IGVycjtcblxuICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAnbnVtYmVyJylcbiAgICAgICAgICAgIGFyZ3MuZHVyYXRpb24gPSBkdXJhdGlvbjtcblxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihhcmdzLCB7XG4gICAgICAgICAgICB0ZXN0UnVuSWQ6IHRlc3RSdW4uaWQsXG4gICAgICAgICAgICB0ZXN0OiAgICAgIHtcbiAgICAgICAgICAgICAgICBpZDogICAgdGVzdFJ1bi50ZXN0LmlkLFxuICAgICAgICAgICAgICAgIG5hbWU6ICB0ZXN0UnVuLnRlc3QubmFtZSxcbiAgICAgICAgICAgICAgICBwaGFzZTogdGVzdFJ1bi5waGFzZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmaXh0dXJlOiB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGVzdFJ1bi50ZXN0LmZpeHR1cmUubmFtZSxcbiAgICAgICAgICAgICAgICBpZDogICB0ZXN0UnVuLnRlc3QuZml4dHVyZS5pZFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvbW1hbmQ6IGZvcm1hdENvbW1hbmQoY29tbWFuZCwgcmVzdWx0KSxcbiAgICAgICAgICAgIGJyb3dzZXI6IGdldEJyb3dzZXIodGVzdFJ1bi5icm93c2VyQ29ubmVjdGlvbiksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBkaXNwYXRjaFRvUGx1Z2luICh7IG1ldGhvZCwgYXJncyA9IFtdIH06IFBsdWdpbk1ldGhvZEFyZ3VtZW50cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW5bbWV0aG9kXSguLi5hcmdzKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAob3JpZ2luYWxFcnJvcikge1xuICAgICAgICAgICAgY29uc3QgdW5jYXVnaHRFcnJvciA9IG5ldyBSZXBvcnRlclBsdWdpbkVycm9yKHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLnBsdWdpbi5uYW1lLFxuICAgICAgICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy50YXNrLmVtaXQoJ2Vycm9yJywgdW5jYXVnaHRFcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vbmNlVGFza1N0YXJ0SGFuZGxlciAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSAgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBjb25zdCB1c2VyQWdlbnRzID0gdGhpcy50YXNrLmJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLm1hcChncm91cCA9PiBncm91cFswXS51c2VyQWdlbnQpO1xuICAgICAgICBjb25zdCBmaXJzdCAgICAgID0gdGhpcy5yZXBvcnRRdWV1ZVswXTtcblxuICAgICAgICBjb25zdCB0YXNrUHJvcGVydGllcyA9IHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb246IHRoaXMudGFzay5vcHRzXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0VGFza1N0YXJ0LFxuICAgICAgICAgICAgYXJnczogICBbXG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lLFxuICAgICAgICAgICAgICAgIHVzZXJBZ2VudHMsXG4gICAgICAgICAgICAgICAgdGhpcy50ZXN0Q291bnQsXG4gICAgICAgICAgICAgICAgdGhpcy50YXNrLnRlc3RTdHJ1Y3R1cmUsXG4gICAgICAgICAgICAgICAgdGFza1Byb3BlcnRpZXNcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0Rml4dHVyZVN0YXJ0LFxuICAgICAgICAgICAgYXJnczogICBbXG4gICAgICAgICAgICAgICAgZmlyc3QuZml4dHVyZS5uYW1lLFxuICAgICAgICAgICAgICAgIGZpcnN0LmZpeHR1cmUucGF0aCxcbiAgICAgICAgICAgICAgICBmaXJzdC5maXh0dXJlLm1ldGFcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfb25UYXNrVGVzdFJ1blN0YXJ0SGFuZGxlciAodGVzdFJ1bjogVGVzdFJ1bik6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zdCByZXBvcnRJdGVtID0gdGhpcy5fZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4odGVzdFJ1bikgYXMgUmVwb3J0SXRlbTtcblxuICAgICAgICByZXBvcnRJdGVtLnRlc3RSdW5JZHMucHVzaCh0ZXN0UnVuLmlkKTtcblxuICAgICAgICBpZiAoIXJlcG9ydEl0ZW0uc3RhcnRUaW1lKVxuICAgICAgICAgICAgcmVwb3J0SXRlbS5zdGFydFRpbWUgPSArbmV3IERhdGUoKTtcblxuICAgICAgICByZXBvcnRJdGVtLnBlbmRpbmdTdGFydHMtLTtcblxuICAgICAgICBpZiAoIXJlcG9ydEl0ZW0ucGVuZGluZ1N0YXJ0cykge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luLnJlcG9ydFRlc3RTdGFydCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RTdGFydEluZm8gPSB7IHRlc3RSdW5JZHM6IHJlcG9ydEl0ZW0udGVzdFJ1bklkcywgdGVzdElkOiByZXBvcnRJdGVtLnRlc3QuaWQgfTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hUb1BsdWdpbih7XG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0VGVzdFN0YXJ0IGFzIHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogICBbXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBvcnRJdGVtLnRlc3QubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdC5tZXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGVzdFN0YXJ0SW5mb1xuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIChyZXBvcnRJdGVtLnBlbmRpbmdUZXN0UnVuU3RhcnRQcm9taXNlLnJlc29sdmUgYXMgRnVuY3Rpb24pKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVwb3J0SXRlbS5wZW5kaW5nVGVzdFJ1blN0YXJ0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblRhc2tUZXN0UnVuRG9uZUhhbmRsZXIgKHRlc3RSdW46IFRlc3RSdW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgcmVwb3J0SXRlbSAgICAgICAgICAgICAgICAgICAgPSB0aGlzLl9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1bih0ZXN0UnVuKSBhcyBSZXBvcnRJdGVtO1xuICAgICAgICBjb25zdCBpc1Rlc3RSdW5TdG9wcGVkVGFza0V4ZWN1dGlvbiA9ICEhdGVzdFJ1bi5lcnJzLmxlbmd0aCAmJiB0aGlzLnN0b3BPbkZpcnN0RmFpbDtcblxuICAgICAgICByZXBvcnRJdGVtLnBlbmRpbmdSdW5zID0gaXNUZXN0UnVuU3RvcHBlZFRhc2tFeGVjdXRpb24gPyAwIDogcmVwb3J0SXRlbS5wZW5kaW5nUnVucyAtIDE7XG4gICAgICAgIHJlcG9ydEl0ZW0udW5zdGFibGUgICAgPSByZXBvcnRJdGVtLnVuc3RhYmxlIHx8IHRlc3RSdW4udW5zdGFibGU7XG4gICAgICAgIHJlcG9ydEl0ZW0uZXJycyAgICAgICAgPSByZXBvcnRJdGVtLmVycnMuY29uY2F0KHRlc3RSdW4uZXJycyk7XG4gICAgICAgIHJlcG9ydEl0ZW0ud2FybmluZ3MgICAgPSB0ZXN0UnVuLndhcm5pbmdMb2cgPyB1bmlvbihyZXBvcnRJdGVtLndhcm5pbmdzLCB0ZXN0UnVuLndhcm5pbmdMb2cubWVzc2FnZXMpIDogW107XG5cbiAgICAgICAgcmVwb3J0SXRlbS5icm93c2Vycy5wdXNoKE9iamVjdC5hc3NpZ24oeyB0ZXN0UnVuSWQ6IHRlc3RSdW4uaWQgfSwgZ2V0QnJvd3Nlcih0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uKSkpO1xuXG4gICAgICAgIGlmICghcmVwb3J0SXRlbS5wZW5kaW5nUnVucylcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc29sdmVSZXBvcnRJdGVtKHJlcG9ydEl0ZW0sIHRlc3RSdW4pO1xuXG4gICAgICAgIGF3YWl0IHJlcG9ydEl0ZW0ucGVuZGluZ1Rlc3RSdW5Eb25lUHJvbWlzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblRhc2tUZXN0QWN0aW9uU3RhcnQgKHsgYXBpQWN0aW9uTmFtZSwgLi4ucmVzdEFyZ3MgfTogUmVwb3J0VGFza0FjdGlvbkV2ZW50QXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKHRoaXMucGx1Z2luLnJlcG9ydFRlc3RBY3Rpb25TdGFydCkge1xuICAgICAgICAgICAgcmVzdEFyZ3MgPSB0aGlzLl9wcmVwYXJlUmVwb3J0VGVzdEFjdGlvbkV2ZW50QXJncyhyZXN0QXJncyBhcyB1bmtub3duIGFzIFJlcG9ydFRlc3RBY3Rpb25FdmVudEFyZ3VtZW50cyk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hUb1BsdWdpbih7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRUZXN0QWN0aW9uU3RhcnQgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgIGFyZ3M6ICAgW1xuICAgICAgICAgICAgICAgICAgICBhcGlBY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgICAgICByZXN0QXJnc1xuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfb25UYXNrVGVzdEFjdGlvbkRvbmUgKHsgYXBpQWN0aW9uTmFtZSwgLi4ucmVzdEFyZ3MgfTogUmVwb3J0VGFza0FjdGlvbkV2ZW50QXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKHRoaXMucGx1Z2luLnJlcG9ydFRlc3RBY3Rpb25Eb25lKSB7XG4gICAgICAgICAgICByZXN0QXJncyA9IHRoaXMuX3ByZXBhcmVSZXBvcnRUZXN0QWN0aW9uRXZlbnRBcmdzKHJlc3RBcmdzIGFzIHVua25vd24gYXMgUmVwb3J0VGVzdEFjdGlvbkV2ZW50QXJndW1lbnRzKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFJlcG9ydGVyUGx1Z2luTWV0aG9kLnJlcG9ydFRlc3RBY3Rpb25Eb25lIGFzIHN0cmluZyxcbiAgICAgICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICAgICAgYXBpQWN0aW9uTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcmVzdEFyZ3NcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX29uY2VUYXNrRG9uZUhhbmRsZXIgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgICAgICBwYXNzZWRDb3VudDogIHRoaXMucGFzc2VkLFxuICAgICAgICAgICAgZmFpbGVkQ291bnQ6ICB0aGlzLmZhaWxlZCxcbiAgICAgICAgICAgIHNraXBwZWRDb3VudDogdGhpcy5za2lwcGVkXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0VGFza0RvbmUsXG4gICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICBlbmRUaW1lLFxuICAgICAgICAgICAgICAgIHRoaXMucGFzc2VkLFxuICAgICAgICAgICAgICAgIHRoaXMudGFzay53YXJuaW5nTG9nLm1lc3NhZ2VzLFxuICAgICAgICAgICAgICAgIHJlc3VsdFxuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICAodGhpcy5wZW5kaW5nVGFza0RvbmVQcm9taXNlLnJlc29sdmUgYXMgRnVuY3Rpb24pKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYXNzaWduVGFza0V2ZW50SGFuZGxlcnMgKCk6IHZvaWQge1xuICAgICAgICBjb25zdCB0YXNrID0gdGhpcy50YXNrO1xuXG4gICAgICAgIHRhc2sub25jZSgnc3RhcnQnLCBhc3luYyAoKSA9PiBhd2FpdCB0aGlzLl9vbmNlVGFza1N0YXJ0SGFuZGxlcigpKTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LXJ1bi1zdGFydCcsIGFzeW5jIHRlc3RSdW4gPT4gYXdhaXQgdGhpcy5fb25UYXNrVGVzdFJ1blN0YXJ0SGFuZGxlcih0ZXN0UnVuKSk7XG5cbiAgICAgICAgdGFzay5vbigndGVzdC1ydW4tZG9uZScsIGFzeW5jIHRlc3RSdW4gPT4gYXdhaXQgdGhpcy5fb25UYXNrVGVzdFJ1bkRvbmVIYW5kbGVyKHRlc3RSdW4pKTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LWFjdGlvbi1zdGFydCcsIGFzeW5jIGUgPT4gYXdhaXQgdGhpcy5fb25UYXNrVGVzdEFjdGlvblN0YXJ0KGUpKTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LWFjdGlvbi1kb25lJywgYXN5bmMgZSA9PiBhd2FpdCB0aGlzLl9vblRhc2tUZXN0QWN0aW9uRG9uZShlKSk7XG5cbiAgICAgICAgdGFzay5vbmNlKCdkb25lJywgYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5fb25jZVRhc2tEb25lSGFuZGxlcigpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZGlzcG9zZSAoKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGlmICh0aGlzLmRpc3Bvc2VkKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xuXG4gICAgICAgIGlmICghdGhpcy5vdXRTdHJlYW0gfHwgUmVwb3J0ZXIuX2lzU3BlY2lhbFN0cmVhbSh0aGlzLm91dFN0cmVhbSkgfHwgIWlzV3JpdGFibGVTdHJlYW0odGhpcy5vdXRTdHJlYW0pKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIGNvbnN0IHN0cmVhbUZpbmlzaGVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRTdHJlYW0ub25jZSgnZmluaXNoJywgcmVzb2x2ZSk7XG4gICAgICAgICAgICB0aGlzLm91dFN0cmVhbS5vbmNlKCdlcnJvcicsIHJlc29sdmUpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLm91dFN0cmVhbS5lbmQoKTtcblxuICAgICAgICByZXR1cm4gc3RyZWFtRmluaXNoZWRQcm9taXNlO1xuICAgIH1cbn1cbiJdfQ==