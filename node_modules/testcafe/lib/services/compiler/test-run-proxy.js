"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const test_run_tracker_1 = __importDefault(require("../../api/test-run-tracker"));
const prerender_callsite_1 = __importDefault(require("../../utils/prerender-callsite"));
const test_controller_1 = __importDefault(require("../../api/test-controller"));
const observed_callsites_storage_1 = __importDefault(require("../../test-run/observed-callsites-storage"));
const warning_log_1 = __importDefault(require("../../notifications/warning-log"));
const executor_1 = __importDefault(require("../../assertions/executor"));
const type_1 = __importDefault(require("../../test-run/commands/type"));
const serviceCommands = __importStar(require("../../test-run/commands/service"));
const get_assertion_timeout_1 = __importDefault(require("../../utils/get-options/get-assertion-timeout"));
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const phase_1 = __importDefault(require("../../test-run/phase"));
const test_run_1 = require("../../errors/test-run");
const phase_2 = __importDefault(require("../../role/phase"));
const promisify_event_1 = __importDefault(require("promisify-event"));
const bookmark_1 = __importDefault(require("../../test-run/bookmark"));
const actions_1 = require("../../test-run/commands/actions");
const browser_console_messages_1 = __importDefault(require("../../test-run/browser-console-messages"));
class TestRunProxy {
    constructor({ dispatcher, id, test, options }) {
        this.debugging = false;
        this.onAny = lodash_1.noop;
        this.dispatcher = dispatcher;
        this.id = id;
        this.test = test;
        this.ctx = Object.create(null);
        this.fixtureCtx = Object.create(null);
        this._options = options;
        this.currentRoleId = null;
        this.usedRoleStates = Object.create(null);
        // TODO: Synchronize these properties with their real counterparts in the main process.
        // Postponed until (GH-3244). See details in (GH-5250).
        this.controller = new test_controller_1.default(this);
        this.observedCallsites = new observed_callsites_storage_1.default();
        this.warningLog = new warning_log_1.default();
        test_run_tracker_1.default.addActiveTestRun(this);
        this._initializeRequestHooks();
    }
    _initializeRequestHooks() {
        this.test.requestHooks.forEach(this._attachWarningLog, this);
    }
    async _executeAssertion(command, callsite) {
        const assertionTimeout = get_assertion_timeout_1.default(command, this._options);
        const executor = new executor_1.default(command, assertionTimeout, callsite);
        executor.once('start-assertion-retries', timeout => this.executeCommand(new serviceCommands.ShowAssertionRetriesStatusCommand(timeout)));
        executor.once('end-assertion-retries', success => this.executeCommand(new serviceCommands.HideAssertionRetriesStatusCommand(success)));
        return executor.run();
    }
    async _getStateSnapshotFromRole(role) {
        const prevPhase = await this.dispatcher.getTestRunPhase({ testRunId: this.id });
        await this.dispatcher.setTestRunPhase({
            testRunId: this.id,
            value: phase_1.default.inRoleInitializer
        });
        if (role.phase === phase_2.default.uninitialized)
            await role.initialize(this);
        else if (role.phase === phase_2.default.pendingInitialization)
            await promisify_event_1.default(role, 'initialized');
        if (role.initErr)
            throw role.initErr;
        await this.dispatcher.setTestRunPhase({
            testRunId: this.id,
            value: prevPhase
        });
        return role.stateSnapshot;
    }
    async _useRole(role, callsite) {
        const currentPhase = await this.dispatcher.getTestRunPhase({ testRunId: this.id });
        if (currentPhase === phase_1.default.inRoleInitializer)
            throw new test_run_1.RoleSwitchInRoleInitializerError(callsite);
        const bookmark = new bookmark_1.default(this, role);
        await bookmark.init();
        if (this.currentRoleId)
            this.usedRoleStates[this.currentRoleId] = await this.dispatcher.getStateSnapshot({ testRunId: this.id });
        const stateSnapshot = this.usedRoleStates[role.id] || await this._getStateSnapshotFromRole(role);
        await this.dispatcher.useStateSnapshot({
            testRunId: this.id,
            snapshot: stateSnapshot
        });
        this.currentRoleId = role.id;
        await bookmark.restore(callsite, stateSnapshot);
    }
    _decorateWithFlag(fn, flagName, value) {
        return async () => {
            // @ts-ignore
            this[flagName] = value;
            try {
                return await fn();
            }
            catch (err) {
                throw err;
            }
            finally {
                // @ts-ignore
                this[flagName] = !value;
            }
        };
    }
    decoratePreventEmitActionEvents(fn, { prevent }) {
        return this._decorateWithFlag(fn, 'preventEmitActionEvents', prevent);
    }
    decorateDisableDebugBreakpoints(fn, { disable }) {
        return this._decorateWithFlag(fn, 'disableDebugBreakpoints', disable);
    }
    _attachWarningLog(hook) {
        hook._warningLog = this.warningLog;
    }
    _detachWarningLog(hook) {
        hook._warningLog = null;
    }
    async executeAction(apiMethodName, command, callsite) {
        const renderedCallsite = callsite ? prerender_callsite_1.default(callsite) : null;
        if (command.type === type_1.default.assertion)
            return this._executeAssertion(command, renderedCallsite);
        else if (command.type === type_1.default.useRole)
            return this._useRole(command.role, renderedCallsite);
        return this.dispatcher.executeAction({
            apiMethodName,
            command,
            callsite: renderedCallsite,
            id: this.id
        });
    }
    executeActionSync(apiMethodName, command, callsite) {
        const renderedCallsite = callsite ? prerender_callsite_1.default(callsite) : null;
        if (command.type === type_1.default.assertion)
            return this._executeAssertion(command, renderedCallsite);
        return this.dispatcher.executeActionSync({
            apiMethodName,
            command,
            callsite: renderedCallsite,
            id: this.id
        });
    }
    async executeCommand(command) {
        return this.dispatcher.executeCommand({ command, id: this.id });
    }
    async addRequestHook(hook) {
        if (this.test.requestHooks.includes(hook))
            return;
        this.test.requestHooks.push(hook);
        this._attachWarningLog(hook);
        await this.dispatcher.addRequestEventListeners({
            hookId: hook.id,
            hookClassName: hook._className,
            rules: hook._requestFilterRules
        });
    }
    async removeRequestHook(hook) {
        if (!this.test.requestHooks.includes(hook))
            return;
        lodash_1.pull(this.test.requestHooks, hook);
        this._detachWarningLog(hook);
        await this.dispatcher.removeRequestEventListeners({ rules: hook._requestFilterRules });
    }
    async getCurrentUrl() {
        return this.dispatcher.getCurrentUrl({ testRunId: this.id });
    }
    async switchToCleanRun(url) {
        this.ctx = Object.create(null);
        this.fixtureCtx = Object.create(null);
        await this.dispatcher.setBrowserConsoleMessages({
            testRunId: this.id,
            value: new browser_console_messages_1.default()
        });
        await this.dispatcher.useStateSnapshot({
            testRunId: this.id,
            snapshot: testcafe_hammerhead_1.StateSnapshot.empty()
        });
        if (await this.speed !== this._options.speed) {
            const setSpeedCommand = new actions_1.SetTestSpeedCommand({ speed: this._options.speed });
            await this.executeCommand(setSpeedCommand);
        }
        if (await this.pageLoadTimeout !== this._options.pageLoadTimeout) {
            const setPageLoadTimeoutCommand = new actions_1.SetPageLoadTimeoutCommand({ duration: this._options.pageLoadTimeout });
            await this.executeCommand(setPageLoadTimeoutCommand);
        }
        await this.navigateToUrl(url, true);
        if (await this.activeDialogHandler) {
            const removeDialogHandlerCommand = new actions_1.SetNativeDialogHandlerCommand({ dialogHandler: { fn: null } });
            await this.executeCommand(removeDialogHandlerCommand);
        }
    }
    async getStateSnapshot() {
        return this.dispatcher.getStateSnapshot({ testRunId: this.id });
    }
    async navigateToUrl(url, forceReload, stateSnapshot) {
        const navigateCommand = new actions_1.NavigateToCommand({ url, forceReload, stateSnapshot });
        await this.executeCommand(navigateCommand);
    }
    get activeDialogHandler() {
        return this.dispatcher.getActiveDialogHandler({ testRunId: this.id });
    }
    get activeIframeSelector() {
        return this.dispatcher.getActiveIframeSelector({ testRunId: this.id });
    }
    get speed() {
        return this.dispatcher.getSpeed({ testRunId: this.id });
    }
    get pageLoadTimeout() {
        return this.dispatcher.getPageLoadTimeout({ testRunId: this.id });
    }
    get consoleMessages() {
        return this.dispatcher.getBrowserConsoleMessages({ testRunId: this.id });
    }
    get phase() {
        return this.dispatcher.getTestRunPhase({ testRunId: this.id });
    }
    async setConsoleMessages(value) {
        await this.dispatcher.setBrowserConsoleMessages({
            testRunId: this.id,
            value
        });
    }
    async setPhase(value) {
        await this.dispatcher.setTestRunPhase({
            testRunId: this.id,
            value
        });
    }
}
exports.default = TestRunProxy;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1ydW4tcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1ydW4tcHJveHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbUNBQW9DO0FBQ3BDLGtGQUF3RDtBQUN4RCx3RkFBK0Q7QUFFL0QsZ0ZBQXVEO0FBQ3ZELDJHQUFpRjtBQUNqRixrRkFBeUQ7QUFFekQseUVBQTBEO0FBRTFELHdFQUF3RDtBQUV4RCxpRkFBbUU7QUFJbkUsMEdBQWdGO0FBQ2hGLDZEQUFvRDtBQUVwRCxpRUFBZ0Q7QUFDaEQsb0RBQXlFO0FBRXpFLDZEQUEwQztBQUMxQyxzRUFBNkM7QUFDN0MsdUVBQXNEO0FBRXRELDZEQU15QztBQUV6Qyx1R0FBNkU7QUFHN0UsTUFBTSxZQUFZO0lBZWQsWUFBb0IsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQW9CO1FBUmhFLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFDM0IsVUFBSyxHQUFhLGFBQUksQ0FBQztRQVExQixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUU3QixJQUFJLENBQUMsRUFBRSxHQUFXLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFTLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsR0FBRyxHQUFVLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxRQUFRLEdBQUssT0FBTyxDQUFDO1FBRTFCLElBQUksQ0FBQyxhQUFhLEdBQUksSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUxQyx1RkFBdUY7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Q1AsQ0FBQztDQUNKO0FBRUQsa0JBQWUsWUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHVsbCwgbm9vcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdGVzdFJ1blRyYWNrZXIgZnJvbSAnLi4vLi4vYXBpL3Rlc3QtcnVuLXRyYWNrZXInO1xuaW1wb3J0IHByZXJlbmRlckNhbGxzaXRlIGZyb20gJy4uLy4uL3V0aWxzL3ByZXJlbmRlci1jYWxsc2l0ZSc7XG5pbXBvcnQgeyBUZXN0UnVuRGlzcGF0Y2hlclByb3RvY29sIH0gZnJvbSAnLi9wcm90b2NvbCc7XG5pbXBvcnQgVGVzdENvbnRyb2xsZXIgZnJvbSAnLi4vLi4vYXBpL3Rlc3QtY29udHJvbGxlcic7XG5pbXBvcnQgT2JzZXJ2ZWRDYWxsc2l0ZXNTdG9yYWdlIGZyb20gJy4uLy4uL3Rlc3QtcnVuL29ic2VydmVkLWNhbGxzaXRlcy1zdG9yYWdlJztcbmltcG9ydCBXYXJuaW5nTG9nIGZyb20gJy4uLy4uL25vdGlmaWNhdGlvbnMvd2FybmluZy1sb2cnO1xuaW1wb3J0IEFzc2VydGlvbkNvbW1hbmQgZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYXNzZXJ0aW9uJztcbmltcG9ydCBBc3NlcnRpb25FeGVjdXRvciBmcm9tICcuLi8uLi9hc3NlcnRpb25zL2V4ZWN1dG9yJztcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IENPTU1BTkRfVFlQRSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy90eXBlJztcbmltcG9ydCBDb21tYW5kQmFzZSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9iYXNlJztcbmltcG9ydCAqIGFzIHNlcnZpY2VDb21tYW5kcyBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9zZXJ2aWNlJztcbmltcG9ydCB7IFRlc3RSdW5Qcm94eUluaXQgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCBUZXN0IGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdCc7XG5pbXBvcnQgUmVxdWVzdEhvb2sgZnJvbSAnLi4vLi4vYXBpL3JlcXVlc3QtaG9va3MvaG9vayc7XG5pbXBvcnQgZ2V0QXNzZXJ0aW9uVGltZW91dCBmcm9tICcuLi8uLi91dGlscy9nZXQtb3B0aW9ucy9nZXQtYXNzZXJ0aW9uLXRpbWVvdXQnO1xuaW1wb3J0IHsgU3RhdGVTbmFwc2hvdCB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IHsgQ2FsbHNpdGVSZWNvcmQgfSBmcm9tICdjYWxsc2l0ZS1yZWNvcmQnO1xuaW1wb3J0IFRlc3RSdW5QaGFzZSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9waGFzZSc7XG5pbXBvcnQgeyBSb2xlU3dpdGNoSW5Sb2xlSW5pdGlhbGl6ZXJFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycy90ZXN0LXJ1bic7XG5pbXBvcnQgUm9sZSBmcm9tICcuLi8uLi9yb2xlL3JvbGUnO1xuaW1wb3J0IFJPTEVfUEhBU0UgZnJvbSAnLi4vLi4vcm9sZS9waGFzZSc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBUZXN0UnVuQm9va21hcmsgZnJvbSAnLi4vLi4vdGVzdC1ydW4vYm9va21hcmsnO1xuXG5pbXBvcnQge1xuICAgIFNldFRlc3RTcGVlZENvbW1hbmQsXG4gICAgU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCxcbiAgICBTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCxcbiAgICBOYXZpZ2F0ZVRvQ29tbWFuZCxcbiAgICBVc2VSb2xlQ29tbWFuZFxufSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9hY3Rpb25zJztcblxuaW1wb3J0IEJyb3dzZXJDb25zb2xlTWVzc2FnZXMgZnJvbSAnLi4vLi4vdGVzdC1ydW4vYnJvd3Nlci1jb25zb2xlLW1lc3NhZ2VzJztcbmltcG9ydCB7IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQsIEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQgfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vYnNlcnZhdGlvbic7XG5cbmNsYXNzIFRlc3RSdW5Qcm94eSB7XG4gICAgcHVibGljIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gICAgcHVibGljIHJlYWRvbmx5IHRlc3Q6IFRlc3Q7XG4gICAgcHVibGljIHJlYWRvbmx5IGNvbnRyb2xsZXI6IFRlc3RDb250cm9sbGVyO1xuICAgIHB1YmxpYyByZWFkb25seSBvYnNlcnZlZENhbGxzaXRlczogT2JzZXJ2ZWRDYWxsc2l0ZXNTdG9yYWdlO1xuICAgIHB1YmxpYyByZWFkb25seSB3YXJuaW5nTG9nOiBXYXJuaW5nTG9nO1xuICAgIHB1YmxpYyBmaXh0dXJlQ3R4OiBvYmplY3Q7XG4gICAgcHVibGljIGRlYnVnZ2luZzogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHB1YmxpYyBvbkFueTogRnVuY3Rpb24gPSBub29wO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGlzcGF0Y2hlcjogVGVzdFJ1bkRpc3BhdGNoZXJQcm90b2NvbDtcbiAgICBwdWJsaWMgY3R4OiBvYmplY3Q7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfb3B0aW9uczogRGljdGlvbmFyeTxPcHRpb25WYWx1ZT47XG4gICAgcHJpdmF0ZSBjdXJyZW50Um9sZUlkOiBzdHJpbmcgfCBudWxsO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlZFJvbGVTdGF0ZXM6IFJlY29yZDxzdHJpbmcsIGFueT47XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKHsgZGlzcGF0Y2hlciwgaWQsIHRlc3QsIG9wdGlvbnMgfTogVGVzdFJ1blByb3h5SW5pdCkge1xuICAgICAgICB0aGlzLmRpc3BhdGNoZXIgPSBkaXNwYXRjaGVyO1xuXG4gICAgICAgIHRoaXMuaWQgICAgICAgICA9IGlkO1xuICAgICAgICB0aGlzLnRlc3QgICAgICAgPSB0ZXN0O1xuICAgICAgICB0aGlzLmN0eCAgICAgICAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICB0aGlzLmZpeHR1cmVDdHggPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICB0aGlzLl9vcHRpb25zICAgPSBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuY3VycmVudFJvbGVJZCAgPSBudWxsO1xuICAgICAgICB0aGlzLnVzZWRSb2xlU3RhdGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgICAgICAvLyBUT0RPOiBTeW5jaHJvbml6ZSB0aGVzZSBwcm9wZXJ0aWVzIHdpdGggdGhlaXIgcmVhbCBjb3VudGVycGFydHMgaW4gdGhlIG1haW4gcHJvY2Vzcy5cbiAgICAgICAgLy8gUG9zdHBvbmVkIHVudGlsIChHSC0zMjQ0KS4gU2VlIGRldGFpbHMgaW4gKEdILTUyNTApLlxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgICAgICAgID0gbmV3IFRlc3RDb250cm9sbGVyKHRoaXMpO1xuICAgICAgICB0aGlzLm9ic2VydmVkQ2FsbHNpdGVzID0gbmV3IE9ic2VydmVkQ2FsbHNpdGVzU3RvcmFnZSgpO1xuICAgICAgICB0aGlzLndhcm5pbmdMb2cgICAgICAgID0gbmV3IFdhcm5pbmdMb2coKTtcblxuICAgICAgICB0ZXN0UnVuVHJhY2tlci5hZGRBY3RpdmVUZXN0UnVuKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVSZXF1ZXN0SG9va3MoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0aWFsaXplUmVxdWVzdEhvb2tzICgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5mb3JFYWNoKHRoaXMuX2F0dGFjaFdhcm5pbmdMb2csIHRoaXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2V4ZWN1dGVBc3NlcnRpb24gKGNvbW1hbmQ6IEFzc2VydGlvbkNvbW1hbmQsIGNhbGxzaXRlOiB1bmtub3duKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnN0IGFzc2VydGlvblRpbWVvdXQgPSBnZXRBc3NlcnRpb25UaW1lb3V0KGNvbW1hbmQsIHRoaXMuX29wdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IGV4ZWN1dG9yID0gbmV3IEFzc2VydGlvbkV4ZWN1dG9yKGNvbW1hbmQsIGFzc2VydGlvblRpbWVvdXQsIGNhbGxzaXRlKTtcblxuICAgICAgICBleGVjdXRvci5vbmNlKCdzdGFydC1hc3NlcnRpb24tcmV0cmllcycsIHRpbWVvdXQgPT4gdGhpcy5leGVjdXRlQ29tbWFuZChuZXcgc2VydmljZUNvbW1hbmRzLlNob3dBc3NlcnRpb25SZXRyaWVzU3RhdHVzQ29tbWFuZCh0aW1lb3V0KSBhcyB1bmtub3duIGFzIENvbW1hbmRCYXNlKSk7XG4gICAgICAgIGV4ZWN1dG9yLm9uY2UoJ2VuZC1hc3NlcnRpb24tcmV0cmllcycsIHN1Y2Nlc3MgPT4gdGhpcy5leGVjdXRlQ29tbWFuZChuZXcgc2VydmljZUNvbW1hbmRzLkhpZGVBc3NlcnRpb25SZXRyaWVzU3RhdHVzQ29tbWFuZChzdWNjZXNzKSBhcyB1bmtub3duIGFzIENvbW1hbmRCYXNlKSk7XG5cbiAgICAgICAgcmV0dXJuIGV4ZWN1dG9yLnJ1bigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2dldFN0YXRlU25hcHNob3RGcm9tUm9sZSAocm9sZTogUm9sZSk6IFByb21pc2U8U3RhdGVTbmFwc2hvdD4ge1xuICAgICAgICBjb25zdCBwcmV2UGhhc2UgPSBhd2FpdCB0aGlzLmRpc3BhdGNoZXIuZ2V0VGVzdFJ1blBoYXNlKHsgdGVzdFJ1bklkOiB0aGlzLmlkIH0pO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5zZXRUZXN0UnVuUGhhc2Uoe1xuICAgICAgICAgICAgdGVzdFJ1bklkOiB0aGlzLmlkLFxuICAgICAgICAgICAgdmFsdWU6ICAgICBUZXN0UnVuUGhhc2UuaW5Sb2xlSW5pdGlhbGl6ZXJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJvbGUucGhhc2UgPT09IFJPTEVfUEhBU0UudW5pbml0aWFsaXplZClcbiAgICAgICAgICAgIGF3YWl0IHJvbGUuaW5pdGlhbGl6ZSh0aGlzKTtcblxuICAgICAgICBlbHNlIGlmIChyb2xlLnBoYXNlID09PSBST0xFX1BIQVNFLnBlbmRpbmdJbml0aWFsaXphdGlvbilcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2lmeUV2ZW50KHJvbGUsICdpbml0aWFsaXplZCcpO1xuXG4gICAgICAgIGlmIChyb2xlLmluaXRFcnIpXG4gICAgICAgICAgICB0aHJvdyByb2xlLmluaXRFcnI7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaGVyLnNldFRlc3RSdW5QaGFzZSh7XG4gICAgICAgICAgICB0ZXN0UnVuSWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICB2YWx1ZTogICAgIHByZXZQaGFzZVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcm9sZS5zdGF0ZVNuYXBzaG90O1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX3VzZVJvbGUgKHJvbGU6IFJvbGUsIGNhbGxzaXRlOiB1bmtub3duKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQaGFzZSA9IGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5nZXRUZXN0UnVuUGhhc2UoeyB0ZXN0UnVuSWQ6IHRoaXMuaWQgfSk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRQaGFzZSA9PT0gVGVzdFJ1blBoYXNlLmluUm9sZUluaXRpYWxpemVyKVxuICAgICAgICAgICAgdGhyb3cgbmV3IFJvbGVTd2l0Y2hJblJvbGVJbml0aWFsaXplckVycm9yKGNhbGxzaXRlKTtcblxuICAgICAgICBjb25zdCBib29rbWFyayA9IG5ldyBUZXN0UnVuQm9va21hcmsodGhpcywgcm9sZSk7XG5cbiAgICAgICAgYXdhaXQgYm9va21hcmsuaW5pdCgpO1xuXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRSb2xlSWQpXG4gICAgICAgICAgICB0aGlzLnVzZWRSb2xlU3RhdGVzW3RoaXMuY3VycmVudFJvbGVJZF0gPSBhd2FpdCB0aGlzLmRpc3BhdGNoZXIuZ2V0U3RhdGVTbmFwc2hvdCh7IHRlc3RSdW5JZDogdGhpcy5pZCB9KTtcblxuICAgICAgICBjb25zdCBzdGF0ZVNuYXBzaG90ID0gdGhpcy51c2VkUm9sZVN0YXRlc1tyb2xlLmlkXSB8fCBhd2FpdCB0aGlzLl9nZXRTdGF0ZVNuYXBzaG90RnJvbVJvbGUocm9sZSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaGVyLnVzZVN0YXRlU25hcHNob3Qoe1xuICAgICAgICAgICAgdGVzdFJ1bklkOiB0aGlzLmlkLFxuICAgICAgICAgICAgc25hcHNob3Q6ICBzdGF0ZVNuYXBzaG90XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY3VycmVudFJvbGVJZCA9IHJvbGUuaWQ7XG5cbiAgICAgICAgYXdhaXQgYm9va21hcmsucmVzdG9yZShjYWxsc2l0ZSBhcyBDYWxsc2l0ZVJlY29yZCwgc3RhdGVTbmFwc2hvdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGVjb3JhdGVXaXRoRmxhZyAoZm46IEZ1bmN0aW9uLCBmbGFnTmFtZTogc3RyaW5nLCB2YWx1ZTogYm9vbGVhbik6ICgpID0+IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgdGhpc1tmbGFnTmFtZV0gPSB2YWx1ZTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgZm4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgdGhpc1tmbGFnTmFtZV0gPSAhdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIGRlY29yYXRlUHJldmVudEVtaXRBY3Rpb25FdmVudHMgKGZuOiBGdW5jdGlvbiwgeyBwcmV2ZW50IH06IHsgcHJldmVudDogYm9vbGVhbiB9KTogKCkgPT4gUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZWNvcmF0ZVdpdGhGbGFnKGZuLCAncHJldmVudEVtaXRBY3Rpb25FdmVudHMnLCBwcmV2ZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVjb3JhdGVEaXNhYmxlRGVidWdCcmVha3BvaW50cyAoZm46IEZ1bmN0aW9uLCB7IGRpc2FibGUgfTogeyBkaXNhYmxlOiBib29sZWFuIH0pOiAoKSA9PiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RlY29yYXRlV2l0aEZsYWcoZm4sICdkaXNhYmxlRGVidWdCcmVha3BvaW50cycsIGRpc2FibGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2F0dGFjaFdhcm5pbmdMb2cgKGhvb2s6IFJlcXVlc3RIb29rKTogdm9pZCB7XG4gICAgICAgIGhvb2suX3dhcm5pbmdMb2cgPSB0aGlzLndhcm5pbmdMb2c7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGV0YWNoV2FybmluZ0xvZyAoaG9vazogUmVxdWVzdEhvb2spOiB2b2lkIHtcbiAgICAgICAgaG9vay5fd2FybmluZ0xvZyA9IG51bGw7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVBY3Rpb24gKGFwaU1ldGhvZE5hbWU6IHN0cmluZywgY29tbWFuZDogQ29tbWFuZEJhc2UsIGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zdCByZW5kZXJlZENhbGxzaXRlID0gY2FsbHNpdGUgPyBwcmVyZW5kZXJDYWxsc2l0ZShjYWxsc2l0ZSkgOiBudWxsO1xuXG4gICAgICAgIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5hc3NlcnRpb24pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZUFzc2VydGlvbihjb21tYW5kIGFzIEFzc2VydGlvbkNvbW1hbmQsIHJlbmRlcmVkQ2FsbHNpdGUpO1xuXG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnVzZVJvbGUpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdXNlUm9sZSgoY29tbWFuZCBhcyBVc2VSb2xlQ29tbWFuZCkucm9sZSwgcmVuZGVyZWRDYWxsc2l0ZSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hlci5leGVjdXRlQWN0aW9uKHtcbiAgICAgICAgICAgIGFwaU1ldGhvZE5hbWUsXG4gICAgICAgICAgICBjb21tYW5kLFxuICAgICAgICAgICAgY2FsbHNpdGU6IHJlbmRlcmVkQ2FsbHNpdGUsXG4gICAgICAgICAgICBpZDogICAgICAgdGhpcy5pZFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhlY3V0ZUFjdGlvblN5bmMgKGFwaU1ldGhvZE5hbWU6IHN0cmluZywgY29tbWFuZDogQ29tbWFuZEJhc2UsIGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IHVua25vd24ge1xuICAgICAgICBjb25zdCByZW5kZXJlZENhbGxzaXRlID0gY2FsbHNpdGUgPyBwcmVyZW5kZXJDYWxsc2l0ZShjYWxsc2l0ZSkgOiBudWxsO1xuXG4gICAgICAgIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5hc3NlcnRpb24pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZUFzc2VydGlvbihjb21tYW5kIGFzIEFzc2VydGlvbkNvbW1hbmQsIHJlbmRlcmVkQ2FsbHNpdGUpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZXhlY3V0ZUFjdGlvblN5bmMoe1xuICAgICAgICAgICAgYXBpTWV0aG9kTmFtZSxcbiAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICBjYWxsc2l0ZTogcmVuZGVyZWRDYWxsc2l0ZSxcbiAgICAgICAgICAgIGlkOiAgICAgICB0aGlzLmlkXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQ29tbWFuZCAoY29tbWFuZDogQ29tbWFuZEJhc2UpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hlci5leGVjdXRlQ29tbWFuZCh7IGNvbW1hbmQsIGlkOiB0aGlzLmlkIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhZGRSZXF1ZXN0SG9vayAoaG9vazogUmVxdWVzdEhvb2spOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MuaW5jbHVkZXMoaG9vaykpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5wdXNoKGhvb2spO1xuICAgICAgICB0aGlzLl9hdHRhY2hXYXJuaW5nTG9nKGhvb2spO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5hZGRSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoe1xuICAgICAgICAgICAgaG9va0lkOiAgICAgICAgaG9vay5pZCxcbiAgICAgICAgICAgIGhvb2tDbGFzc05hbWU6IGhvb2suX2NsYXNzTmFtZSxcbiAgICAgICAgICAgIHJ1bGVzOiAgICAgICAgIGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlc1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVtb3ZlUmVxdWVzdEhvb2sgKGhvb2s6IFJlcXVlc3RIb29rKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5pbmNsdWRlcyhob29rKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBwdWxsKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MsIGhvb2spO1xuICAgICAgICB0aGlzLl9kZXRhY2hXYXJuaW5nTG9nKGhvb2spO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5yZW1vdmVSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoeyBydWxlczogaG9vay5fcmVxdWVzdEZpbHRlclJ1bGVzIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRDdXJyZW50VXJsICgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaGVyLmdldEN1cnJlbnRVcmwoeyB0ZXN0UnVuSWQ6IHRoaXMuaWQgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHN3aXRjaFRvQ2xlYW5SdW4gKHVybDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuY3R4ICAgICAgICA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIHRoaXMuZml4dHVyZUN0eCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaGVyLnNldEJyb3dzZXJDb25zb2xlTWVzc2FnZXMoe1xuICAgICAgICAgICAgdGVzdFJ1bklkOiB0aGlzLmlkLFxuICAgICAgICAgICAgdmFsdWU6ICAgICBuZXcgQnJvd3NlckNvbnNvbGVNZXNzYWdlcygpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci51c2VTdGF0ZVNuYXBzaG90KHtcbiAgICAgICAgICAgIHRlc3RSdW5JZDogdGhpcy5pZCxcbiAgICAgICAgICAgIHNuYXBzaG90OiAgU3RhdGVTbmFwc2hvdC5lbXB0eSgpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChhd2FpdCB0aGlzLnNwZWVkICE9PSB0aGlzLl9vcHRpb25zLnNwZWVkKSB7XG4gICAgICAgICAgICBjb25zdCBzZXRTcGVlZENvbW1hbmQgPSBuZXcgU2V0VGVzdFNwZWVkQ29tbWFuZCh7IHNwZWVkOiB0aGlzLl9vcHRpb25zLnNwZWVkIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGVDb21tYW5kKHNldFNwZWVkQ29tbWFuZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXdhaXQgdGhpcy5wYWdlTG9hZFRpbWVvdXQgIT09IHRoaXMuX29wdGlvbnMucGFnZUxvYWRUaW1lb3V0KSB7XG4gICAgICAgICAgICBjb25zdCBzZXRQYWdlTG9hZFRpbWVvdXRDb21tYW5kID0gbmV3IFNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQoeyBkdXJhdGlvbjogdGhpcy5fb3B0aW9ucy5wYWdlTG9hZFRpbWVvdXQgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUNvbW1hbmQoc2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLm5hdmlnYXRlVG9VcmwodXJsLCB0cnVlKTtcblxuICAgICAgICBpZiAoYXdhaXQgdGhpcy5hY3RpdmVEaWFsb2dIYW5kbGVyKSB7XG4gICAgICAgICAgICBjb25zdCByZW1vdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCA9IG5ldyBTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCh7IGRpYWxvZ0hhbmRsZXI6IHsgZm46IG51bGwgfSB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChyZW1vdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0U3RhdGVTbmFwc2hvdCAoKTogUHJvbWlzZTxTdGF0ZVNuYXBzaG90PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZ2V0U3RhdGVTbmFwc2hvdCh7IHRlc3RSdW5JZDogdGhpcy5pZCB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgbmF2aWdhdGVUb1VybCAodXJsOiBzdHJpbmcsIGZvcmNlUmVsb2FkOiBib29sZWFuLCBzdGF0ZVNuYXBzaG90Pzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IG5hdmlnYXRlQ29tbWFuZCA9IG5ldyBOYXZpZ2F0ZVRvQ29tbWFuZCh7IHVybCwgZm9yY2VSZWxvYWQsIHN0YXRlU25hcHNob3QgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChuYXZpZ2F0ZUNvbW1hbmQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgYWN0aXZlRGlhbG9nSGFuZGxlciAoKTogUHJvbWlzZTxFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kIHwgbnVsbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaGVyLmdldEFjdGl2ZURpYWxvZ0hhbmRsZXIoeyB0ZXN0UnVuSWQ6IHRoaXMuaWQgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBhY3RpdmVJZnJhbWVTZWxlY3RvciAoKTogUHJvbWlzZTxFeGVjdXRlU2VsZWN0b3JDb21tYW5kIHwgbnVsbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaGVyLmdldEFjdGl2ZUlmcmFtZVNlbGVjdG9yKHsgdGVzdFJ1bklkOiB0aGlzLmlkIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc3BlZWQgKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZ2V0U3BlZWQoeyB0ZXN0UnVuSWQ6IHRoaXMuaWQgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBwYWdlTG9hZFRpbWVvdXQgKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZ2V0UGFnZUxvYWRUaW1lb3V0KHsgdGVzdFJ1bklkOiB0aGlzLmlkIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgY29uc29sZU1lc3NhZ2VzICgpOiBQcm9taXNlPEJyb3dzZXJDb25zb2xlTWVzc2FnZXM+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hlci5nZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzKHsgdGVzdFJ1bklkOiB0aGlzLmlkIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcGhhc2UgKCk6IFByb21pc2U8VGVzdFJ1blBoYXNlPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZ2V0VGVzdFJ1blBoYXNlKHsgdGVzdFJ1bklkOiB0aGlzLmlkIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRDb25zb2xlTWVzc2FnZXMgKHZhbHVlOiBCcm93c2VyQ29uc29sZU1lc3NhZ2VzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5zZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzKHtcbiAgICAgICAgICAgIHRlc3RSdW5JZDogdGhpcy5pZCxcbiAgICAgICAgICAgIHZhbHVlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzZXRQaGFzZSAodmFsdWU6IFRlc3RSdW5QaGFzZSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoZXIuc2V0VGVzdFJ1blBoYXNlKHtcbiAgICAgICAgICAgIHRlc3RSdW5JZDogdGhpcy5pZCxcbiAgICAgICAgICAgIHZhbHVlXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGVzdFJ1blByb3h5O1xuXG5cbiJdfQ==